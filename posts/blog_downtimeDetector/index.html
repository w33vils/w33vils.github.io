<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="layout-lang" content="en"><meta name="day-prompt" content="d ago"><meta name="hour-prompt" content="hr ago"><meta name="minute-prompt" content="min ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Python DowntimeDetector" /><meta name="author" content="w33vils" /><meta property="og:locale" content="en" /><meta name="description" content="What it is …" /><meta property="og:description" content="What it is …" /><link rel="canonical" href="https://w33vils.github.io/posts/blog_downtimeDetector/" /><meta property="og:url" content="https://w33vils.github.io/posts/blog_downtimeDetector/" /><meta property="og:site_name" content="w33vil’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-08-23T08:00:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Python DowntimeDetector" /><meta name="twitter:site" content="@w33vils" /><meta name="twitter:creator" content="@w33vils" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"w33vils"},"dateModified":"2021-08-09T11:38:55+03:00","datePublished":"2020-08-23T08:00:00+03:00","description":"What it is …","headline":"Python DowntimeDetector","mainEntityOfPage":{"@type":"WebPage","@id":"https://w33vils.github.io/posts/blog_downtimeDetector/"},"url":"https://w33vils.github.io/posts/blog_downtimeDetector/"}</script><title>Python DowntimeDetector | w33vil's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="w33vil's blog"><meta name="application-name" content="w33vil's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang=""><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/prof.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">w33vil's blog</a></div><div class="site-subtitle font-italic">Pentester</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/w33vils" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/w33vils" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['uv.w','outlook.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Python DowntimeDetector</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Python DowntimeDetector</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> w33vils </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Aug 23, 2020, 8:00 AM +0300" >Aug 23, 2020<i class="unloaded">2020-08-23T08:00:00+03:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Aug 9, 2021, 11:38 AM +0300" >Aug 9, 2021<i class="unloaded">2021-08-09T11:38:55+03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1027 words">5 min read</span></div></div><div class="post-content"><h2 id="what-it-is-">What it is …</h2><p>Earlier on I wrote about how I wanted to get high severity notifications about a particular critical system on my Telegram channel. That was pushed by desire of not having work emails enabled on my mobile device, but also not miss on critical system alerts, that are usually shared via mail by the system.</p><p>You can read about it under the <a href="https://w33vils.github.io/posts/blog_emailbot/">Python - emailBot</a> section and the code <a href="https://github.com/w33vils/emailBot">here</a>.</p><p>A flaw in the project is that, in the event the entire system goes offline, it would not send any alerts that I would then capture from the emails. I needed a different way to monitor the host itself, independently from itself. Sure, there are many (and perhaps more efficient) ways to achieve this, but I wanted to play around and do it via a customized script. A way to learn the language too.</p><h2 id="tasks">Tasks</h2><p>On a high level, I needed a script that would:</p><ul><li>Can monitor a system’s uptime<li>Send an alert to my Telegram channel in the event of a failure<li>Provide continuos monitoring after the fact<li>Monitor multiple hosts at the same time</ul><p>So, what do you do when you have a coding problem?</p><p><img data-proofer-ignore data-src="https://media.giphy.com/media/eBD5RhS0n5JgA/giphy.gif" alt="" /></p><h2 id="code">Code</h2><h3 id="continuos-monitoring">Continuos monitoring</h3><p>I found an interesting <code class="language-plaintext highlighter-rouge">python</code> module - <a href="https://github.com/romana/multi-ping">multiping</a> which allows you to monitor multiple hosts using ping requests. The module works by sending multiple retries within a defined timeout period to a set of hosts and records which ones are online or offline. A test of the module runs as below:</p><div lang="python" class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">multiping</span> <span class="kn">import</span> <span class="n">multi_ping</span>

<span class="n">addrs</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">8.8.8.8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">youtube.com</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">192.168.50.100</span><span class="sh">"</span><span class="p">]</span>

<span class="c1"># Ping the addresses up to 4 times (initial ping + 3 retries), over the
# course of 2 seconds. This means that for those addresses that do not
# respond another ping will be sent every 0.5 seconds.
</span><span class="n">responses</span><span class="p">,</span> <span class="n">no_responses</span> <span class="o">=</span> <span class="nf">multi_ping</span><span class="p">(</span><span class="n">addrs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Responses : %s</span><span class="sh">"</span> <span class="o">%</span> <span class="nf">list</span><span class="p">(</span><span class="n">responses</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span>
      <span class="sh">"</span><span class="s">No Responses : </span><span class="sh">"</span> <span class="o">+</span><span class="nf">str </span><span class="p">(</span><span class="n">no_responses</span><span class="p">))</span>
</pre></table></code></div></div><p>From which you get a similar result to the one below:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Responses : ['8.8.8.8', '216.58.223.78'] 
No Responses : ['192.168.50.100']
</pre></table></code></div></div><p>From here, it gets simple. We just loop through the code and then send an alert anytime there is a downtime and another alert when the host comes back online.</p><h3 id="timestamp">Timestamp</h3><p>Before doing that, we need functions to check the timestamp, another to calculate the time difference and the last one to send the telegram message.</p><p>The code gets us the current time.</p><div lang="python" class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">current_timestamp</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
</pre></table></code></div></div><p>While the python method piece below gets the time difference:</p><div lang="python" class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">time_difference</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">difference</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">secs</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">difference</span><span class="p">.</span><span class="nf">total_seconds</span><span class="p">())</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="nf">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nf">float</span><span class="p">(</span><span class="n">secs</span><span class="p">))).</span><span class="nf">split</span><span class="p">((</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</pre></table></code></div></div><p>We will constantly call this method to get the timestamp when needed, (e.g., when we want to know for how long the host has been offline.)</p><h3 id="telegram-messages">Telegram Messages</h3><p>To send messages to Telegram, we need a <code class="language-plaintext highlighter-rouge">bot</code> and a <code class="language-plaintext highlighter-rouge">channel</code>. The bot needs to be an administrator on the channel. <a href="https://core.telegram.org/bots#:~:text=for%20existing%20ones.-,Creating%20a%20new%20bot,mentions%20and%20t.me%20links.">Create a Bot with BotFather</a> and note the <code class="language-plaintext highlighter-rouge">bot token</code>. Then create a public channel and add the bot as an administrator.</p><p>To get the channel ID (which we will use as the chat ID), post the URL below on your browser, replacing the <code class="language-plaintext highlighter-rouge">bot_token</code> with your bot token.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>https://api.telegram.org/bot&lt;bot_token&gt;/getupdates
</pre></table></code></div></div><p>Then post a random message on the channel and reload the link. You will see the chat ID as</p><p><code class="language-plaintext highlighter-rouge">"chat":{"id":-xxxxxxxxxxx, ...</code></p><p>The Telegram function below takes the message and uses a telegram bot token, to send a message to the telegram channel or chat.</p><div lang="python" class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>  <span class="k">def</span> <span class="nf">botsy</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">,</span> <span class="n">telegram_message</span><span class="p">):</span>
    <span class="n">bot</span> <span class="o">=</span> <span class="n">telegram</span><span class="p">.</span><span class="nc">Bot</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">bot</span><span class="p">.</span><span class="nf">sendMessage</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">telegram_message</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="finally">Finally</h3><p>We need to continously monitor the system for uptime and downtimes. For this, we can implement a simple while loop as below.</p><div lang="python" class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="k">while</span> <span class="bp">True</span><span class="p">:</span> <span class="c1">#loop through the check host function
</span>    <span class="k">if</span> <span class="nf">check_host</span><span class="p">(</span><span class="n">addrs</span><span class="p">):</span>
        <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">down_time</span> <span class="o">=</span> <span class="nf">current_timestamp</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">☒ Host </span><span class="sh">"</span> <span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span> <span class="sh">"</span><span class="s"> is down as at </span><span class="sh">"</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">down_time</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nf">botsy</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="nf">check_host</span><span class="p">(</span><span class="n">addrs</span><span class="p">):</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="nf">current_timestamp</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">☒</span><span class="sh">"</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> Has been down for </span><span class="sh">"</span> <span class="o">+</span> <span class="nf">time_difference</span><span class="p">(</span><span class="n">down_time</span><span class="p">,</span>
                                                                                      <span class="n">current_time</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> HH:MM:SS</span><span class="sh">"</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">600</span><span class="p">:</span>
                <span class="nf">botsy</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">30</span><span class="p">:</span> <span class="c1">#3600
</span>                <span class="nf">botsy</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">45</span><span class="p">:</span> <span class="c1">#10800
</span>                <span class="nf">botsy</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">60</span><span class="p">:</span> <span class="c1">#21600
</span>                <span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">☒ Host</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> has been down for over an hour. No more alerts will be sent. </span><span class="sh">"</span>
                <span class="nf">botsy</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="n">up_time</span> <span class="o">=</span> <span class="nf">current_timestamp</span><span class="p">()</span> <span class="c1">#Get restoration time
</span>        <span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">✅ Host </span><span class="sh">"</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> is now up after </span><span class="sh">"</span> <span class="o">+</span> <span class="nf">time_difference</span><span class="p">(</span><span class="n">down_time</span><span class="p">,</span> <span class="n">up_time</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> HH:MM:SS</span><span class="sh">"</span>
        <span class="nf">botsy</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</pre></table></code></div></div><p>The loop continuously checks the <code class="language-plaintext highlighter-rouge">check_host</code> function, if the provided address is up, it does nothing. If it is down, it picks the current downtime from the <code class="language-plaintext highlighter-rouge">check_downtime</code> method, and sends it to Telegram via the bot.</p><p>We then use a basic counter to split our reminders. In this case, if a host is not up after ten minutes, a reminder will be sent after 10 minutes, then after 30 minutes and finally after one hour, after which no further alerts are sent.</p><p>This helps with alert fatigue, Plus, if it’s still offline after one hour, it probably wasn’t too important for you, was it?</p><h2 id="improvements">Improvements</h2><ul><li>The obvious issue with the code is that, while <code class="language-plaintext highlighter-rouge">multiping</code> module has the capability to ping multiple hosts, my humble code has not achieved this. So far, it can only ping one host at a time.</ul><p>Theoretically, this can be fixed by implementing a database of the hosts and and their states at any time and reading and updating as they come up or go down. This can also be done by updating an excel sheet, but a database would certainly make you look smarter.</p><p>I will be looking to update this post once I fix the issues, but for now you can find the full code to monitor the single host using ping, with Telegram notification, on my <a href="https://github.com/w33vils/downtimeDetector">Github page</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blog/'>Blog</a>, <a href='/categories/scripts/'>Scripts</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/downtime/" class="post-tag no-text-decoration" >downtime</a> <a href="/tags/telegram/" class="post-tag no-text-decoration" >telegram</a> <a href="/tags/regex/" class="post-tag no-text-decoration" >regex</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Python DowntimeDetector - w33vil's blog&url=https://w33vils.github.io/posts/blog_downtimeDetector/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Python DowntimeDetector - w33vil's blog&u=https://w33vils.github.io/posts/blog_downtimeDetector/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Python DowntimeDetector - w33vil's blog&url=https://w33vils.github.io/posts/blog_downtimeDetector/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/oscp_review/">My OSCP Experience</a><li><a href="/posts/blog_downtimeDetector/">Python DowntimeDetector</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/regex/">regex</a> <a class="post-tag" href="/tags/telegram/">telegram</a> <a class="post-tag" href="/tags/tryhackme/">TryHackMe</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/cockpit/">cockpit</a> <a class="post-tag" href="/tags/crtp/">CRTP</a> <a class="post-tag" href="/tags/downtime/">downtime</a> <a class="post-tag" href="/tags/email/">email</a> <a class="post-tag" href="/tags/mona/">mona</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/blog_emailbot/"><div class="card-body"> <span class="timeago small" >Aug 21, 2020<i class="unloaded">2020-08-21T08:00:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python emailBot</h3><div class="text-muted small"><p> Email - Telegram Python Bot As a a cyber security architect, I am often responsible for some critical security infrastructure, whose uptime is, well, you guessed it, paramount. Usually, these syst...</p></div></div></a></div><div class="card"> <a href="/posts/oscp_review/"><div class="card-body"> <span class="timeago small" >Jul 31, 2021<i class="unloaded">2021-07-31T08:00:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>My OSCP Experience</h3><div class="text-muted small"><p> I recently passed the Offensive Security Certified Professional (OSCP) exam, and as is a rite of passage, I will shamelessly add to the already existing, hundreds of reviews! If you are reading th...</p></div></div></a></div><div class="card"> <a href="/posts/crtp-review/"><div class="card-body"> <span class="timeago small" >Sep 9, 2022<i class="unloaded">2022-09-09T08:00:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CRTP Review</h3><div class="text-muted small"><p> I recently passed the Certified Red Team Professional (CRTP) exam by Pentester Academy and thought I’d give my two unsolicited cents on what I considered a maximum value for both time and money. ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/blog_emailbot/" class="btn btn-outline-primary" prompt="Older"><p>Python emailBot</p></a> <a href="/posts/thm_gatekeeper_walkthrough/" class="btn btn-outline-primary" prompt="Newer"><p>THM - GateKeeper Walkthrough</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/w33vils">Brian Ombongi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/regex/">regex</a> <a class="post-tag" href="/tags/telegram/">telegram</a> <a class="post-tag" href="/tags/tryhackme/">TryHackMe</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/cockpit/">cockpit</a> <a class="post-tag" href="/tags/crtp/">CRTP</a> <a class="post-tag" href="/tags/downtime/">downtime</a> <a class="post-tag" href="/tags/email/">email</a> <a class="post-tag" href="/tags/mona/">mona</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://w33vils.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
