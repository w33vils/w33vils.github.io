<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="layout-lang" content="en"><meta name="day-prompt" content="d ago"><meta name="hour-prompt" content="hr ago"><meta name="minute-prompt" content="min ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Python emailBot" /><meta name="author" content="w33vils" /><meta property="og:locale" content="en" /><meta name="description" content="Email - Telegram Python Bot" /><meta property="og:description" content="Email - Telegram Python Bot" /><link rel="canonical" href="https://w33vils.github.io/posts/blog_emailbot/" /><meta property="og:url" content="https://w33vils.github.io/posts/blog_emailbot/" /><meta property="og:site_name" content="w33vil’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-08-21T08:00:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Python emailBot" /><meta name="twitter:site" content="@w33vils" /><meta name="twitter:creator" content="@w33vils" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"w33vils"},"dateModified":"2020-08-21T08:00:00+03:00","datePublished":"2020-08-21T08:00:00+03:00","description":"Email - Telegram Python Bot","headline":"Python emailBot","mainEntityOfPage":{"@type":"WebPage","@id":"https://w33vils.github.io/posts/blog_emailbot/"},"url":"https://w33vils.github.io/posts/blog_emailbot/"}</script><title>Python emailBot | w33vil's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="w33vil's blog"><meta name="application-name" content="w33vil's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang=""><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/prof.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">w33vil's blog</a></div><div class="site-subtitle font-italic">Pentester</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/w33vils" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/w33vils" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['uv.w','outlook.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Python emailBot</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Python emailBot</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> w33vils </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Aug 21, 2020, 8:00 AM +0300" >Aug 21, 2020<i class="unloaded">2020-08-21T08:00:00+03:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1082 words">6 min read</span></div></div><div class="post-content"><h1 id="email---telegram-python-bot">Email - Telegram Python Bot</h1><p>As a a cyber security architect, I am often responsible for some critical security infrastructure, whose uptime is, well, you guessed it, paramount. Usually, these systems have some sort of warning bells when hell breaks loose, and this can be in the form of email alerts, or monitoring dashboards.</p><p>I wrote this script to avoid checking emails on weekends. You probably also, don’t want to go back to work on Monday, to find your infrastructure went off on Friday evening, and no one was there to give it CPR.</p><p><img data-proofer-ignore data-src="https://media.giphy.com/media/26AHLsZkEKRGMFgFq/giphy.gif" alt="" /></p><p>Since I am always on my phone, I wanted an easier, less stressful way to receive high priority alerts.</p><h2 id="problem-statement">Problem Statement</h2><p>I was responsible for a system that generated such email alerts as below, sometimes in thousands:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>Event Type: Gateway state change
Time: 8/4/20 11:04 PM
Subsystem: Gateway
Severity: High
Message: The status of the gateway SERVER1-GW-01 is Disconnected. Please check the gateways section of the user interface for additional information.
Reporting Component Name: SERVER1-GW-01
Reporting Component IP: X.X.X.X
</pre></table></code></div></div><p>I wanted to filter from the thousands of similar alerts, get the Critical severity ones (usually pointing to a downtime) in a stripped-down format, sent to my phone.</p><h2 id="pseudo-code">Pseudo-Code</h2><ul><li><p>Scan an email folder for unread emails</p><li><p>Parse the emails and extract the content</p><li><p>Find the most important parts of the message</p><li><p>Send the information as a Telegram alert</p></ul><p>I found a fantastic blog on <a href="https://repl.it/talk/learn/How-to-Make-a-Python-Email-Bot/8194">repl</a> which helped me quickly cover some bits of the task.</p><h2 id="code">Code</h2><p>The complete code is available on my <a href="https://github.com/w33vils/emailBot">Github Page</a>. I have explained the important bits below.</p><ul><li><h3 id="connecting-to-the-email-server">Connecting to the email Server</h3></ul><p>In this code, I will be using Outlook as the email server. We will use the <code class="language-plaintext highlighter-rouge">imapclient python</code> library to connect to the outlook server. The imapclient library implements a method that takes the <em>username</em> and <em>email</em> and connects to the email server.</p><div lang="python" class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Initializing IMAP ... </span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">""</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">connect</span>
        <span class="n">connect</span> <span class="o">=</span> <span class="n">imapclient</span><span class="p">.</span><span class="nc">IMAPClient</span><span class="p">(</span><span class="n">imap_server</span><span class="p">)</span>
        <span class="n">connect</span><span class="p">.</span><span class="nf">login</span><span class="p">(</span><span class="n">read_from</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">connect</span><span class="p">.</span><span class="nf">select_folder</span><span class="p">(</span><span class="sh">"</span><span class="s">INBOX</span><span class="sh">"</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Success</span><span class="sh">"</span><span class="p">)</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">readonly=False</code> ensures the emails are marked as read. This avoids duplicates.</p><ul><li><h3 id="reading-emails">Reading emails</h3></ul><p>Unread emails are returned as <code class="language-plaintext highlighter-rouge">UIDs</code>. The UIDs are what we use to fetch actual emails.</p><div lang="python" class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">//</span><span class="n">Code</span> <span class="n">that</span> <span class="n">checks</span> <span class="k">for</span> <span class="n">unread</span> <span class="n">emails</span>

<span class="n">uids</span><span class="o">=</span><span class="n">i</span><span class="p">.</span><span class="nf">search</span><span class="p">([</span><span class="sh">'</span><span class="s">UNSEEN</span><span class="sh">'</span><span class="p">])</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">uids</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">None</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Found %s unread emails</span><span class="sh">"</span> <span class="o">%</span><span class="nf">len</span><span class="p">(</span><span class="n">uids</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="p">[</span><span class="sh">'</span><span class="s">BODY[]</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">FLAGS</span><span class="sh">'</span><span class="p">])</span>
</pre></table></code></div></div><p>Next we analyze and return the actual message. <code class="language-plaintext highlighter-rouge">pyzmail</code> module can help us extract the sender, subject, and message. It is important to only analyze messages from the particular sender, to avoid another system or user sending a conflicting email. Also, since I am only interested in the high severity events, I will ignore any emails with a medium or low severity in the subject.</p><div lang="python" class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">message</span><span class="o">=</span><span class="n">pyzmail</span><span class="p">.</span><span class="n">PyzMessage</span><span class="p">.</span><span class="nf">factory</span><span class="p">(</span><span class="n">raws</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="sa">b</span><span class="sh">'</span><span class="s">BODY[]</span><span class="sh">'</span><span class="p">])</span>
<span class="k">global</span> <span class="n">subject</span>
<span class="n">subject</span><span class="o">=</span><span class="n">msg</span><span class="p">.</span><span class="nf">get_subject</span><span class="p">()</span>
<span class="k">from</span><span class="o">=</span><span class="n">msg</span><span class="p">.</span><span class="nf">get_address</span><span class="p">(</span><span class="sh">'</span><span class="s">from</span><span class="sh">'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">frm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sender_address</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Unread is from %s &lt;%s&gt; skipping</span><span class="sh">"</span> <span class="o">%</span><span class="p">(</span><span class="n">frm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">frm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="bp">None</span>
<span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">text_part</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">No message to parse</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>
<span class="k">if</span> <span class="sh">"</span><span class="s">High Severity</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><ul><li><h3 id="extract-the-important-parts-from-the-message">Extract the important parts from the message</h3><p>Using regex, we can analyze the message returned and extract the information, from the data.</p></ul><p>The targeted piece is:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Message: The status of the gateway SERVER1-GW-01 is Disconnected. Please check the gateways section of the user interface for additional information.
</pre></table></code></div></div><p>For a telegram message, we can send <code class="language-plaintext highlighter-rouge">SERVER1-GW-01 is Disconnected</code>, which is short, and most importantly sweet.</p><p>The regex code below does just that.</p><div lang="python" class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">get_event</span><span class="p">(</span><span class="n">raw_msg</span><span class="p">):</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">(\bMessage:)([a-zA-Z0-9-\s]+(\bgateway)([a-zA-Z0-9-\s]+.))</span><span class="sh">'</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">I</span><span class="p">)</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">.</span><span class="nf">finditer</span><span class="p">(</span><span class="n">raw_msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">matches</span>
</pre></table></code></div></div><ul><li><h3 id="sending-the-message-to-telegram">Sending the message to Telegram</h3></ul><p>To send messages to Telegram, we need a <code class="language-plaintext highlighter-rouge">bot</code> and a <code class="language-plaintext highlighter-rouge">channel</code>. The bot needs to be an administrator on the channel. <a href="https://core.telegram.org/bots#:~:text=for%20existing%20ones.-,Creating%20a%20new%20bot,mentions%20and%20t.me%20links.">Create a Bot with BotFather</a> and note the <code class="language-plaintext highlighter-rouge">bot token</code>. Then create a public channel and add the bot as an administrator.</p><p>To get the channel ID (which we will use as the chat ID), post the URL below on your browser, replacing the <code class="language-plaintext highlighter-rouge">bot_token</code> with your bot token.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>https://api.telegram.org/bot&lt;bot_token&gt;/getupdates
</pre></table></code></div></div><p>Then post a random message on the channel and reload the link. You will see the chat ID as</p><p><code class="language-plaintext highlighter-rouge">"chat":{"id":-xxxxxxxxxxx, ...</code></p><p>We can then we use the <code class="language-plaintext highlighter-rouge">sendMessage</code> method to send the alert to Telegram.</p><div lang="python" class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre> <span class="k">def</span> <span class="nf">botsy</span><span class="p">(</span><span class="n">bot_token</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">,</span> <span class="n">telegram_message</span><span class="p">):</span>
    <span class="n">bot</span> <span class="o">=</span> <span class="n">telegram</span><span class="p">.</span><span class="nc">Bot</span><span class="p">(</span><span class="n">bot_token</span><span class="p">)</span>
    <span class="n">bot</span><span class="p">.</span><span class="nf">sendMessage</span><span class="p">(</span><span class="n">chat_ID</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">telegram_message</span><span class="p">)</span>
</pre></table></code></div></div><ul><li><h3 id="finally">Finally</h3></ul><p>Finally, we loop through methods created to monitor for new emails, analyze them, pass them through a regex function to get the required message and send it to Telegram. Then keep waiting for new messages/alerts to arrive.</p><div lang="python" class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">=</span><span class="nf">get_unread</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">messages</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">check_freq</span><span class="p">)</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="nf">get_unread</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nf">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">received_email</span><span class="o">=</span><span class="nf">analyze_msg</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">received_email</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">received_email</span><span class="p">:</span>
                <span class="n">parsed_email</span> <span class="o">=</span> <span class="nf">get_event</span><span class="p">(</span><span class="n">received_email</span><span class="p">)</span>
                <span class="k">for</span> <span class="k">match</span> <span class="ow">in</span> <span class="n">parsed_email</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                        <span class="c1"># print(match.group(4))
</span>                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                        <span class="nf">botsy</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
</pre></table></code></div></div><p>The loop checks for any unread messages and checks whether the sender is from the system we want to monitor. If there are no messages, it sleeps for a defined time interval and rechecks. If a message is received, it is analyzed, and the body part extracted which is then checked by the regex function to determine if it contains the required message that warrants a notification on Telegram. If such an alert exists, it is sent Telegram. The <code class="language-plaintext highlighter-rouge">match.group</code> only checks the fourth item returned from the regex function, since it is the important bit that we care for. This area requires customization to suit your own needs.</p><ul><li><h3 id="one-more-thing">One more thing</h3></ul><p>We create a config file to carry the different variables defined on the code. Which is then imported to the code.</p><p>The code gets the mailbox to read emails from and its associated <code class="language-plaintext highlighter-rouge">imap</code> server, the password using the <code class="language-plaintext highlighter-rouge">getpass</code> library which will hide the password when it’s being typed.</p><div lang="python" class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">getpass</span>

<span class="n">read_from</span><span class="o">=</span><span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">Enter mailbox to read from: </span><span class="sh">"</span><span class="p">)</span>
<span class="n">imap_server</span><span class="o">=</span><span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">Enter imap server: </span><span class="sh">"</span><span class="p">)</span>

<span class="n">paswd</span><span class="o">=</span><span class="n">getpass</span><span class="p">.</span><span class="nf">getpass</span><span class="p">(</span><span class="sh">"</span><span class="s">Account Password: </span><span class="sh">"</span><span class="p">)</span>
<span class="n">sender_address</span> <span class="o">=</span><span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">Enter the trusted system email sender address: </span><span class="sh">"</span><span class="p">)</span>

<span class="n">bot_token</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">bot token : </span><span class="sh">"</span><span class="p">)</span>
<span class="n">chat_ID</span> <span class="o">=</span> <span class="nf">input </span><span class="p">(</span><span class="sh">"</span><span class="s">chat id : </span><span class="sh">"</span><span class="p">)</span>
</pre></table></code></div></div><ul><li><h2 id="results">Results</h2></ul><p>When one of the servers experiences a fault and goes offline, we get a server disconnected alert on telegram and when it gets online, an uptime alert is sent.</p><p><img data-proofer-ignore data-src="/assets/results.png" alt="" /> <em>Notifications sent to Telegram</em></p><p>That’s it!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blog/'>Blog</a>, <a href='/categories/scripts/'>Scripts</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/email/" class="post-tag no-text-decoration" >email</a> <a href="/tags/telegram/" class="post-tag no-text-decoration" >telegram</a> <a href="/tags/regex/" class="post-tag no-text-decoration" >regex</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Python emailBot - w33vil's blog&url=https://w33vils.github.io/posts/blog_emailbot/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Python emailBot - w33vil's blog&u=https://w33vils.github.io/posts/blog_emailbot/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Python emailBot - w33vil's blog&url=https://w33vils.github.io/posts/blog_emailbot/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/oscp_review/">My OSCP Experience</a><li><a href="/posts/blog_downtimeDetector/">Python DowntimeDetector</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/regex/">regex</a> <a class="post-tag" href="/tags/telegram/">telegram</a> <a class="post-tag" href="/tags/tryhackme/">TryHackMe</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/cockpit/">cockpit</a> <a class="post-tag" href="/tags/crtp/">CRTP</a> <a class="post-tag" href="/tags/downtime/">downtime</a> <a class="post-tag" href="/tags/email/">email</a> <a class="post-tag" href="/tags/mona/">mona</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/blog_downtimeDetector/"><div class="card-body"> <span class="timeago small" >Aug 23, 2020<i class="unloaded">2020-08-23T08:00:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python DowntimeDetector</h3><div class="text-muted small"><p> What it is … Earlier on I wrote about how I wanted to get high severity notifications about a particular critical system on my Telegram channel. That was pushed by desire of not having work email...</p></div></div></a></div><div class="card"> <a href="/posts/oscp_review/"><div class="card-body"> <span class="timeago small" >Jul 31, 2021<i class="unloaded">2021-07-31T08:00:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>My OSCP Experience</h3><div class="text-muted small"><p> I recently passed the Offensive Security Certified Professional (OSCP) exam, and as is a rite of passage, I will shamelessly add to the already existing, hundreds of reviews! If you are reading th...</p></div></div></a></div><div class="card"> <a href="/posts/crtp-review/"><div class="card-body"> <span class="timeago small" >Sep 9, 2022<i class="unloaded">2022-09-09T08:00:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CRTP Review</h3><div class="text-muted small"><p> I recently passed the Certified Red Team Professional (CRTP) exam by Pentester Academy and thought I’d give my two unsolicited cents on what I considered a maximum value for both time and money. ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <a href="/posts/blog_downtimeDetector/" class="btn btn-outline-primary" prompt="Newer"><p>Python DowntimeDetector</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/w33vils">Brian Ombongi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/regex/">regex</a> <a class="post-tag" href="/tags/telegram/">telegram</a> <a class="post-tag" href="/tags/tryhackme/">TryHackMe</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/cockpit/">cockpit</a> <a class="post-tag" href="/tags/crtp/">CRTP</a> <a class="post-tag" href="/tags/downtime/">downtime</a> <a class="post-tag" href="/tags/email/">email</a> <a class="post-tag" href="/tags/mona/">mona</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://w33vils.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
